# 变量自动补全功能说明

## 功能概述

Magpie 现在支持在输入时自动补全环境变量。当你输入 `{` 字符时，系统会自动弹出当前激活环境的所有可用变量列表，让你快速选择并插入变量。

## 功能特性

### ✨ 主要特点

1. **智能触发**：输入 `{` 字符自动触发变量补全
2. **全局支持**：在以下所有位置都可以使用变量补全：
   - 请求 URL
   - 查询参数（Params）
   - 请求头（Headers）
   - 表单数据（Form Data / URL Encoded）
   - Bearer Token
   - API Key 值

3. **多变量支持**：可以在同一个字段中使用多个变量
4. **键盘导航**：支持完整的键盘操作
5. **实时预览**：显示变量名称和对应的值

## 使用方法

### 基本使用

1. **创建环境变量**
   - 点击顶部的"环境管理"按钮
   - 创建一个新环境或编辑现有环境
   - 添加变量，例如：
     - `baseUrl`: `https://api.example.com`
     - `token`: `your-api-token-here`
     - `apiVersion`: `v1`

2. **激活环境**
   - 在左侧边栏顶部的环境选择器中选择你创建的环境

3. **使用变量补全**
   - 在 URL 输入框中开始输入
   - 输入 `{` 字符
   - 自动弹出变量列表
   - 使用方向键 ↑↓ 选择变量
   - 按 Enter 或 Tab 键插入变量
   - 变量将以 `{{variableName}}` 格式插入

### 实际示例

#### 示例 1：构建完整的 API URL

假设你有以下环境变量：
```
baseUrl = https://api.example.com
apiVersion = v1
userId = 12345
```

在 URL 输入框中：
1. 输入 `{` → 选择 `baseUrl` → 得到 `{{baseUrl}}`
2. 继续输入 `/api/{` → 选择 `apiVersion` → 得到 `{{baseUrl}}/api/{{apiVersion}}`
3. 继续输入 `/users/{` → 选择 `userId` → 得到 `{{baseUrl}}/api/{{apiVersion}}/users/{{userId}}`

最终 URL：`{{baseUrl}}/api/{{apiVersion}}/users/{{userId}}`

实际发送时会被解析为：`https://api.example.com/api/v1/users/12345`

#### 示例 2：在请求头中使用变量

环境变量：
```
authToken = Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
apiKey = your-api-key-123
```

在 Headers 标签页：
- Key: `Authorization`, Value: 输入 `{` 选择 `authToken`
- Key: `X-API-Key`, Value: 输入 `{` 选择 `apiKey`

#### 示例 3：在查询参数中使用变量

环境变量：
```
pageSize = 20
sortOrder = desc
```

在 Params 标签页：
- Key: `limit`, Value: 输入 `{` 选择 `pageSize`
- Key: `sort`, Value: 输入 `{` 选择 `sortOrder`

### 键盘快捷键

当变量补全列表显示时：

| 快捷键 | 功能 |
|--------|------|
| `↑` | 向上选择 |
| `↓` | 向下选择 |
| `Enter` | 插入选中的变量 |
| `Tab` | 插入选中的变量 |
| `Esc` | 关闭补全列表 |

### 鼠标操作

- **悬停**：鼠标悬停在变量上会高亮显示
- **点击**：点击变量即可插入

## UI 界面说明

### 变量补全下拉框

补全框包含三个部分：

1. **顶部标题栏**
   - 显示 "可用变量 (环境名称)"
   - 快速识别当前使用的环境

2. **变量列表**
   - 每个变量显示两行：
     - 第一行：变量名称（等宽字体）
     - 第二行：变量值（灰色小字）
   - 当前选中的变量会有蓝色背景和边框

3. **底部提示栏**
   - 显示键盘快捷键提示
   - `↑↓ 导航` | `Enter/Tab 选择` | `Esc 关闭`

## 注意事项

### ⚠️ 使用提示

1. **必须激活环境**
   - 只有在选择了环境后，变量补全才会显示
   - 如果没有激活环境，输入 `{` 不会弹出补全列表

2. **只显示已启用的变量**
   - 只有在环境管理中启用（打勾）的变量才会出现在补全列表中
   - 未启用的变量不会显示

3. **变量格式**
   - 变量必须使用双花括号格式：`{{variableName}}`
   - 不要手动输入双花括号，让自动补全为你插入

4. **变量解析**
   - 变量在发送请求时会被自动解析为对应的值
   - 如果变量不存在或未启用，将保持原样发送

### 💡 最佳实践

1. **变量命名**
   - 使用有意义的变量名，如 `baseUrl`、`authToken`
   - 使用驼峰命名法或下划线分隔，如 `api_version` 或 `apiVersion`

2. **环境组织**
   - 为不同的环境（开发、测试、生产）创建不同的环境配置
   - 使用相同的变量名，但不同的值

3. **多变量组合**
   - 善用多个变量组合构建复杂的 URL
   - 例如：`{{baseUrl}}/{{apiVersion}}/{{resource}}/{{id}}`

4. **敏感信息**
   - 将 Token、API Key 等敏感信息存储在环境变量中
   - 避免在请求配置中硬编码敏感信息

## 技术细节

### 变量解析顺序

1. 用户输入 `{` 字符
2. 系统检测到触发字符
3. 获取当前激活环境的所有已启用变量
4. 显示变量补全列表
5. 用户选择变量后，插入 `{{variableName}}` 格式
6. 发送请求时，httpClient 自动将变量替换为实际值

### 支持的输入框类型

- ✅ 单行文本输入框（URL、Token 等）
- ✅ 键值对编辑器（Params、Headers、Form Data）
- ⚠️ 不支持 textarea（JSON、Raw Body）

### 变量作用域

- 变量仅在激活的环境中生效
- 切换环境会立即更新可用的变量列表
- 未激活任何环境时，变量补全功能不可用

## 故障排查

### 问题：输入 `{` 没有弹出补全列表

**可能原因：**
1. 没有激活任何环境 → 在左侧边栏选择一个环境
2. 当前环境没有变量 → 在环境管理中添加变量
3. 所有变量都被禁用 → 在环境管理中启用至少一个变量

### 问题：变量没有被正确解析

**可能原因：**
1. 变量名拼写错误 → 检查变量名是否正确
2. 变量被禁用 → 在环境管理中确认变量已启用
3. 环境未激活 → 确认正确的环境已被选中

### 问题：补全列表闪烁或立即关闭

**可能原因：**
1. 意外点击了输入框外部 → 重新输入 `{` 触发
2. 按了 Esc 键 → 重新输入 `{` 触发

## 版本信息

- **功能版本**：1.0.0
- **添加日期**：2025-10-24
- **适用版本**：Magpie v1.0.0+

## 反馈与建议

如果你在使用过程中遇到问题或有改进建议，欢迎反馈！

