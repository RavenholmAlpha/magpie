# 🌍 Magpie 环境功能完整说明

## ✅ 环境功能已完整实现！

### 📋 **功能概述**

环境（Environment）功能让您能够在不同环境（开发、测试、生产）之间快速切换，无需手动修改每个请求的URL、Token等信息。

---

## 🎯 **核心功能**

### 1. **环境管理界面**
- ✅ 创建新环境
- ✅ 编辑环境变量
- ✅ 删除环境
- ✅ 激活/取消激活环境
- ✅ 查看环境变量数量

### 2. **环境变量系统**
- ✅ 支持在URL中使用变量：`{{baseUrl}}/api/users`
- ✅ 支持在Headers中使用变量：`Authorization: Bearer {{token}}`
- ✅ 支持在Body中使用变量：`{"env": "{{environment}}"}`
- ✅ 自动替换所有变量

### 3. **快速切换**
- ✅ 左侧栏顶部环境选择器
- ✅ 一键切换环境
- ✅ 所有请求自动使用当前环境的变量

---

## 🛠️ **如何使用环境功能**

### **步骤1：打开环境管理器**
1. 点击左侧栏顶部的"管理"按钮
2. 弹出环境管理器窗口

### **步骤2：创建新环境**
1. 在环境管理器中，点击右上角的"新建"按钮
2. 在弹出的输入框中输入环境名称，例如：
   - "开发环境"
   - "测试环境"
   - "生产环境"
3. 按Enter或点击"确认"

### **步骤3：配置环境变量**
1. 在左侧环境列表中选择一个环境
2. 在右侧编辑器中添加变量，例如：

**开发环境变量：**
```
变量名: baseUrl
变量值: http://localhost:3000

变量名: token
变量值: dev_token_123456

变量名: apiVersion
变量值: v1
```

**生产环境变量：**
```
变量名: baseUrl
变量值: https://api.example.com

变量名: token
变量值: prod_token_xyz789

变量名: apiVersion
变量值: v2
```

### **步骤4：激活环境**
1. 在环境列表中，点击环境右侧的"○"按钮激活环境
2. 激活后显示为"√"，并显示"激活中"徽章
3. 也可以在左侧栏顶部的下拉选择器中选择环境

### **步骤5：在请求中使用变量**
在URL框中输入：
```
{{baseUrl}}/{{apiVersion}}/users
```

当激活"开发环境"时，实际发送的URL是：
```
http://localhost:3000/v1/users
```

当激活"生产环境"时，实际发送的URL是：
```
https://api.example.com/v2/users
```

---

## 📖 **使用场景示例**

### **场景1：多环境API测试**

```
环境：本地开发
变量：
  ✓ baseUrl: http://localhost:8080
  ✓ apiKey: local_key_123
  ✓ debug: true

环境：测试服务器
变量：
  ✓ baseUrl: https://test-api.example.com
  ✓ apiKey: test_key_456
  ✓ debug: true

环境：生产服务器
变量：
  ✓ baseUrl: https://api.example.com
  ✓ apiKey: prod_key_xyz
  ✓ debug: false
```

**请求配置（通用）：**
```
URL: {{baseUrl}}/api/users
Headers:
  - X-API-Key: {{apiKey}}
  - X-Debug: {{debug}}
```

**切换环境时，只需在顶部选择器中选择，所有请求自动使用对应环境的变量！**

---

### **场景2：团队协作**

```
环境：张三本地
变量：
  ✓ baseUrl: http://192.168.1.100:3000
  ✓ userId: dev_user_001

环境：李四本地
变量：
  ✓ baseUrl: http://192.168.1.101:3000
  ✓ userId: dev_user_002
```

每个开发者使用自己的环境配置，避免冲突。

---

### **场景3：不同客户/项目**

```
环境：客户A
变量：
  ✓ endpoint: https://client-a.api.com
  ✓ clientId: client_a_12345
  ✓ secret: secret_a

环境：客户B
变量：
  ✓ endpoint: https://client-b.api.com
  ✓ clientId: client_b_67890
  ✓ secret: secret_b
```

---

## 🎨 **环境管理器界面**

### **左侧：环境列表**
```
环境列表                    [新建]
─────────────────────────
□ 开发环境              [√][×]
□ 测试环境 [激活中]      [√][×]
□ 生产环境              [√][×]
```

### **右侧：环境变量编辑器**
```
开发环境
2 个变量
─────────────────────────
💡 如何使用环境变量：
在URL、Headers、Body中使用 {{变量名}} 来引用变量
例如：{{baseUrl}}/api/users
─────────────────────────
变量列表：
☑ baseUrl    http://localhost:3000
☑ token      dev_token_123456
☐ timeout    30
```

---

## 🔧 **技术实现**

### **变量替换逻辑（httpClient.ts）：**

```typescript
function replaceVariables(text: string, environments: Environment[], activeEnvId: string | null): string {
  if (!activeEnvId) return text;
  
  const activeEnv = environments.find(env => env.id === activeEnvId);
  if (!activeEnv) return text;

  let result = text;
  activeEnv.variables.forEach((variable) => {
    if (variable.enabled) {
      const regex = new RegExp(`{{\\s*${variable.key}\\s*}}`, 'g');
      result = result.replace(regex, variable.value);
    }
  });

  return result;
}
```

### **支持的替换位置：**
1. ✅ **URL** - 请求地址
2. ✅ **Query参数** - URL参数值
3. ✅ **Headers** - 请求头值
4. ✅ **Body** - 请求体内容
5. ✅ **Auth** - 认证信息（Token、API Key等）

### **变量格式：**
- 标准格式：`{{variableName}}`
- 支持空格：`{{ variableName }}`
- 大小写敏感
- 自动递归替换

---

## 🧪 **实际使用示例**

### **示例1：基础使用**

**环境配置：**
```
环境名称：开发环境
变量：
  baseUrl = http://localhost:3000
  version = v1
```

**请求配置：**
```
GET {{baseUrl}}/{{version}}/users
```

**实际发送：**
```
GET http://localhost:3000/v1/users
```

---

### **示例2：带认证**

**环境配置：**
```
环境名称：生产环境
变量：
  apiUrl = https://api.example.com
  authToken = eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

**请求配置：**
```
POST {{apiUrl}}/api/login
Headers:
  Authorization: Bearer {{authToken}}
  Content-Type: application/json
```

**实际发送：**
```
POST https://api.example.com/api/login
Headers:
  Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
  Content-Type: application/json
```

---

### **示例3：动态参数**

**环境配置：**
```
环境名称：测试环境
变量：
  host = test.example.com
  userId = test_user_001
  pageSize = 20
```

**请求配置：**
```
GET https://{{host}}/api/users/{{userId}}/posts?limit={{pageSize}}
```

**实际发送：**
```
GET https://test.example.com/api/users/test_user_001/posts?limit=20
```

---

## 💡 **最佳实践**

### **1. 环境变量命名规范**
- ✅ 使用驼峰命名：`baseUrl`, `authToken`
- ✅ 使用下划线：`base_url`, `auth_token`
- ✅ 语义化命名：`apiEndpoint`, `clientId`
- ❌ 避免特殊字符：不要使用空格、中文

### **2. 常用变量建议**
```
baseUrl / apiUrl    - API基础地址
token / authToken   - 认证令牌
apiKey / clientKey  - API密钥
version / apiVersion - API版本
timeout             - 超时时间
debug               - 调试模式
```

### **3. 安全建议**
- ⚠️ 不要将生产环境的敏感信息提交到代码仓库
- ⚠️ 每个开发者应该有自己的本地环境配置
- ⚠️ 定期更新生产环境的token和密钥

---

## 🎯 **功能特性**

### **环境管理器特性：**
- ✅ **双面板设计** - 左侧环境列表，右侧变量编辑
- ✅ **实时编辑** - 修改立即生效
- ✅ **激活状态显示** - 清楚知道哪个环境正在使用
- ✅ **变量计数** - 显示每个环境有多少个变量
- ✅ **使用提示** - 内置使用说明

### **变量编辑器特性：**
- ✅ **Key-Value编辑** - 复用KeyValueEditor组件
- ✅ **启用/禁用** - 可以临时禁用变量
- ✅ **批量管理** - 支持多个变量
- ✅ **实时保存** - 编辑后自动保存

---

## 📦 **文件结构**

```
src/renderer/components/
└── EnvironmentManager.tsx     # 环境管理器组件

src/renderer/utils/
└── httpClient.ts              # 变量替换逻辑

src/renderer/styles/
└── titlebar.css               # 环境管理器样式
```

---

## 🚀 **使用流程**

```
1. 创建环境
   ↓
2. 配置环境变量
   ↓
3. 激活环境
   ↓
4. 在请求中使用 {{变量名}}
   ↓
5. 发送请求（自动替换变量）
   ↓
6. 切换环境时，所有请求自动使用新环境的变量
```

---

## 🎉 **总结**

环境功能现在已经完整实现，包括：

✅ **完整的环境管理界面**
- 创建/编辑/删除环境
- 环境变量管理
- 激活环境

✅ **变量替换系统**
- 支持URL、Headers、Body中的变量
- 自动递归替换
- 支持启用/禁用变量

✅ **用户友好的界面**
- 双面板设计
- 实时编辑
- 使用提示

现在您可以：
1. 点击左侧栏顶部的"管理"按钮打开环境管理器
2. 创建不同的环境（开发、测试、生产等）
3. 为每个环境配置变量
4. 在请求中使用`{{变量名}}`
5. 切换环境下拉选择器来快速切换

**完整的环境功能让API测试更加高效！** 🎯
