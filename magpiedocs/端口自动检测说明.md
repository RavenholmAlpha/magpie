# 🔧 端口自动检测功能说明

## 🎯 问题解决

### **之前的问题：**
- Electron试图连接5173端口，但Vite运行在5174端口
- 端口冲突时应用无法启动
- 需要手动检查端口状态

### **现在的解决方案：**
- ✅ **智能端口检测** - 自动检测可用的端口
- ✅ **多端口支持** - 支持5173, 5174, 5175, 3000, 8080, 4000, 5000
- ✅ **错误提示** - 连接失败时显示友好的错误页面
- ✅ **自动重试** - 支持重新检测端口

## 🛠️ 技术实现

### **1. 端口检测工具 (`src/main/portDetector.ts`)**

```typescript
// 检测端口是否可用
export async function checkPortAvailable(port: number): Promise<boolean>

// 检测端口是否有HTTP服务运行
export async function checkHttpService(port: number): Promise<boolean>

// 智能端口检测
export async function findAvailablePort(): Promise<number | null>
```

### **2. Vite配置优化 (`vite.config.ts`)**

```typescript
server: {
  port: 5173,
  strictPort: false, // 允许端口冲突时自动选择其他端口
  host: 'localhost',
  open: false, // 不自动打开浏览器，由Electron处理
}
```

### **3. Electron主进程优化 (`src/main/main.ts`)**

```typescript
// 智能端口检测
const loadDevServer = async () => {
  const availablePort = await findAvailablePort();
  if (availablePort) {
    await mainWindow.loadURL(`http://localhost:${availablePort}`);
  } else {
    showErrorPage();
  }
};
```

## 🔍 检测流程

### **端口检测顺序：**
1. **5173** - Vite默认端口
2. **5174** - Vite备用端口
3. **5175** - Vite备用端口
4. **3000** - 常用开发端口
5. **8080** - 常用开发端口
6. **4000** - 备用端口
7. **5000** - 备用端口

### **检测逻辑：**
1. **端口可用性检测** - 检查端口是否被占用
2. **HTTP服务检测** - 检查端口是否有HTTP服务运行
3. **连接测试** - 尝试加载URL验证服务可用性
4. **错误处理** - 显示友好的错误页面

## 🎨 用户体验

### **成功连接：**
```
🔍 Starting intelligent port detection...
🔍 Checking port 5173...
❌ Port 5173 is occupied
🔍 Checking port 5174...
✅ Port 5174 has HTTP service running
✅ Successfully loaded dev server on port 5174
```

### **连接失败：**
- 显示友好的错误页面
- 提供解决方案建议
- 支持重新检测按钮

## 🚀 功能特性

### **智能检测：**
- ✅ **多端口支持** - 自动尝试多个端口
- ✅ **超时控制** - 2秒超时避免长时间等待
- ✅ **错误恢复** - 连接失败时显示错误页面
- ✅ **状态反馈** - 详细的控制台日志

### **用户友好：**
- ✅ **自动重试** - 支持重新检测端口
- ✅ **错误提示** - 清晰的错误信息和解决方案
- ✅ **状态显示** - 实时显示检测进度
- ✅ **无需干预** - 完全自动化处理

## 📊 配置说明

### **支持的端口列表：**
```typescript
const ports = [5173, 5174, 5175, 3000, 8080, 4000, 5000];
```

### **超时设置：**
- **端口检测超时：** 2秒
- **启动延迟：** 1秒（给Vite服务器启动时间）

### **错误处理：**
- 显示详细的错误信息
- 提供解决方案建议
- 支持手动重新检测

## 🧪 测试场景

### **场景1：默认端口可用**
- Vite运行在5173端口
- Electron自动连接5173端口
- 应用正常启动

### **场景2：端口冲突**
- 5173端口被占用
- Vite自动选择5174端口
- Electron检测到5174端口并连接
- 应用正常启动

### **场景3：所有端口都被占用**
- 所有端口都被占用
- 显示错误页面
- 提供解决方案建议

## 🎯 使用效果

**现在启动应用时：**
1. **自动检测** - 无需手动指定端口
2. **智能选择** - 自动选择可用的端口
3. **错误提示** - 连接失败时显示友好提示
4. **完全自动化** - 无需用户干预

**解决了端口冲突问题，让开发体验更加流畅！** 🎉
